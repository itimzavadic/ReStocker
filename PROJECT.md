# ReStocker — Инструкция для разработки ИИ-агентом

## 1. Описание проекта

ReStocker — утилитарное приложение для учёта товаров и расходников в малых магазинах и мастерских.

### Основные задачи:
- Контроль остатков расходников (пакеты, материалы, комплектующие)
- Автоматическое списание расходников при продаже техники через CRM
- Ручной режим для магазинов без CRM
- Кнопки "одно действие" для мгновенного списания комплекта расходников
- Telegram Mini App — интерфейс, уведомления и оплата через Telegram
- История операций и аналитика с возможностью экспорта

## 2. Аудитория

### Магазины с CRM-системой
- Автоматизация списания расходников при продаже техники
- Подключение через API/вебхуки

### Магазины без CRM
- Ручной учёт с кнопками "одно действие"
- Возможность переключения с ручной версии на CRM через настройки

## 3. Архитектура Mini App

```
[Telegram Mini App (Webview)]
       │
       ▼
  [Frontend: HTML/CSS/JS (React/Vue)]
       │
       ▼
  [Backend: FastAPI]
       │
       ▼
  [PostgreSQL / база данных]
       │
       ▼
  [Интеграции с CRM через API/Webhook]
```

### Компоненты архитектуры:

- **Frontend (Mini App):** интерфейс Mini App, кнопки, формы, склад, журнал, отчёты
- **Backend (FastAPI):** обработка CRUD, вебхуков, правил списания, авторизации, уведомлений
- **База данных (PostgreSQL):** пользователи, товары, правила, кнопки, журнал
- **Интеграции CRM:** подключение через API для автоматического списания

## 4. Основные экраны Mini App

### 4.1 Первый экран — выбор режима

```
[Добро пожаловать в ReStocker]
Вы используете CRM?

[Да, использую CRM]   [Нет, ручной режим]
```

**Функционал:**
- Выбор между автоматическим режимом (с CRM) и ручным режимом
- Возможность переключения режимов позже в настройках

### 4.2 Экран выбора CRM

```
[Выберите CRM]

[RemOnline] [amoCRM] [U-On] [Poster POS] [Другая CRM (ввести API)]
```

**Функционал:**
- Выбор из популярных CRM или ручной ввод API ключа
- Настройка подключения через вебхуки или polling API

### 4.3 Главный экран

**Навигационное меню:**
```
[Склад]  [Кнопки "одно действие"]  [Журнал]  [Настройки]  [Отчёты/Экспорт]
```

**Описание разделов:**
- **Склад** — управление товарами и расходниками
- **Кнопки "одно действие"** — создание и использование быстрых кнопок списания
- **Журнал** — история всех операций
- **Настройки** — конфигурация приложения и подписка
- **Отчёты/Экспорт** — аналитика и экспорт данных

### 4.4 Экран "Склад"

**Отображение:**
```
Список товаров/расходников:
┌─────────────────────────────────────────────┐
│ Название │ Остаток │ Порог │ Категория     │
├─────────────────────────────────────────────┤
│ Пакет A  │   15    │  10   │ Упаковка      │
│ Материал │    5    │  10   │ Комплектующие │ ⚠️
└─────────────────────────────────────────────┘
```

**Кнопки действий:**
- `[+] Добавить товар` — добавление нового товара/расходника
- `[–] Списать вручную` — ручное списание конкретного товара

**Функционал:**
- Цветовая индикация остатка (красный — ниже порога, жёлтый — близко к порогу)
- Фильтр "Показать только ниже порога"
- Поиск по названию товара
- Сортировка по категориям

### 4.5 Экран "Кнопки 'одно действие'"

**Отображение:**
- Список всех созданных кнопок с названиями изделий

**Создание новой кнопки:**
1. Название кнопки (например: "Продажа ноутбука")
2. Привязка расходников и количества для списания:
   ```
   ┌────────────────────────────────────────┐
   │ Расходник          │ Количество       │
   ├────────────────────────────────────────┤
   │ Пакет упаковочный  │       1          │
   │ Чехол              │       1          │
   │ Гарантийный талон  │       1          │
   └────────────────────────────────────────┘
   ```

**Логика при нажатии кнопки:**
1. Списание всех привязанных расходников с указанным количеством
2. Проверка порогов для каждого списанного расходника
3. Отправка уведомлений в Telegram при достижении порога
4. Автоматическая запись операции в журнал

**Дополнительно:**
- Редактирование существующих кнопок
- Удаление кнопок
- Дублирование кнопки для быстрого создания похожих

### 4.6 Экран "Журнал"

**Отображение:**
```
История операций:
┌──────────────────────────────────────────────────────────────┐
│ Дата/Время       │ Действие │ Товар      │ Источник          │
├──────────────────────────────────────────────────────────────┤
│ 2024-01-15 14:30│ Списание │ Пакет A    │ Ручное            │
│ 2024-01-15 12:15│ Списание │ Материал   │ CRM (RemOnline)   │
│ 2024-01-15 10:00│ Добавление│ Пакет B   │ Ручное            │
└──────────────────────────────────────────────────────────────┘
```

**Фильтры:**
- По дате (выбор диапазона)
- По товару (поиск/выбор из списка)
- По пользователю (для многопользовательских магазинов)
- По источнику (ручной/CRM)
- По типу операции (списание/добавление)

**Дополнительно:**
- Пагинация для больших объёмов данных
- Экспорт отфильтрованных данных

### 4.7 Экран "Настройки"

**Основные настройки:**
- **Режим работы:** переключение между ручной и CRM-версией
- **Уведомления:** настройка Telegram-уведомлений (вкл/выкл, пороги)
- **Управление подпиской:** просмотр тарифа, оплата, пробный период
- **Интеграция CRM:** подключение/отключение CRM, настройка API ключей
- **Профиль:** имя пользователя, email, роль

### 4.8 Экран "Отчёты/Экспорт"

**Доступные отчёты:**
- Движение расходников за период
- Использование кнопок "одно действие"
- Остатки товаров
- История операций по товару

**Формат экспорта:**
- CSV файл
- PDF отчёт

**Функционал:**
- Выбор периода для отчёта
- Фильтры по товарам/категориям
- Настройка полей для экспорта

## 5. Модели данных

### 5.1 Пользователи (User)

```python
User:
  - id: int (PK)
  - имя: str
  - email: str
  - роль: enum (менеджер/владелец)
  - подписка: enum (бесплатная/премиум)
  - telegram_id: int
  - created_at: datetime
```

### 5.2 Товары (Product)

```python
Product:
  - id: int (PK)
  - название: str
  - категория: str
  - единица_измерения: str
  - остаток: float
  - порог: float
  - owner_id: int (FK -> User)
  - created_at: datetime
```

### 5.3 Правила списания (Rule)

```python
Rule:
  - id: int (PK)
  - триггер_тип: enum (товар/категория/ключевое_слово)
  - триггер_значение: str
  - owner_id: int (FK -> User)
  - created_at: datetime

RuleItem:
  - id: int (PK)
  - rule_id: int (FK -> Rule)
  - product_id: int (FK -> Product)
  - количество: float
```

### 5.4 Журнал (SalesLog)

```python
SalesLog:
  - id: int (PK)
  - дата_время: datetime
  - действие: enum (списание/добавление)
  - товар_id: int (FK -> Product)
  - количество: float
  - источник: enum (ручной/CRM/кнопка)
  - источник_детали: str (ID кнопки, название CRM)
  - user_id: int (FK -> User)
```

### 5.5 Кнопки "одно действие" (ManualButton)

```python
ManualButton:
  - id: int (PK)
  - название: str
  - owner_id: int (FK -> User)
  - created_at: datetime

ManualButtonItem:
  - id: int (PK)
  - button_id: int (FK -> ManualButton)
  - product_id: int (FK -> Product)
  - количество: float
```

## 6. Алгоритмы работы

### 6.1 Ручной режим

**Последовательность действий:**

1. **Добавление товаров:**
   - Пользователь добавляет товары и расходники через Mini App
   - Устанавливает пороговое значение для каждого товара

2. **Настройка правил списания:**
   - Пользователь создаёт правила вручную через интерфейс
   - Правила могут быть привязаны к категориям или конкретным товарам

3. **Использование кнопок "одно действие":**
   - Пользователь создаёт кнопку с названием изделия
   - Привязывает расходники и количество для списания
   - При нажатии кнопки происходит:
     - Получение списка привязанных расходников и количеств
     - Для каждого расходника:
       - Уменьшение остатка на указанное количество
       - Проверка порога → если ниже порога, отправка уведомления
       - Запись операции в журнал с источником "кнопка"

4. **Ручное списание:**
   - Пользователь выбирает товар и количество для списания
   - Проверка порога и отправка уведомления при необходимости
   - Запись в журнал с источником "ручное"

5. **Мониторинг:**
   - Автоматическая проверка остатков при каждом списании
   - Telegram-уведомления при достижении порога
   - Журнал операций обновляется в реальном времени

### 6.2 Автоматический режим

**Последовательность действий:**

1. **Подключение CRM:**
   - Пользователь выбирает CRM из списка или вводит API ключ
   - Backend настраивает вебхуки или polling для получения событий продаж

2. **Получение событий продаж:**
   - CRM отправляет вебхук при продаже товара
   - Или Backend периодически опрашивает API CRM на предмет новых продаж

3. **Применение правил списания:**
   - Backend получает информацию о проданном товаре
   - Поиск соответствующих правил списания:
     - По ID товара
     - По категории товара
     - По ключевым словам в названии
   - Для каждого найденного правила:
     - Получение списка расходников для списания
     - Для каждого расходника:
       - Уменьшение остатка на указанное количество
       - Проверка порога → уведомление при необходимости
       - Запись операции в журнал с источником "CRM" и названием CRM

4. **Уведомления:**
   - Telegram-уведомления о низких остатках отправляются владельцу/менеджерам
   - Возможность настройки порога для каждого расходника

5. **Ручная корректировка:**
   - Даже в автоматическом режиме пользователь может:
     - Вручную добавить товар
     - Вручную списать товар
     - Использовать кнопки "одно действие"

## 7. Уведомления

### Типы уведомлений:
- **Низкий остаток:** товар достиг или опустился ниже порога
- **Критический остаток:** товар полностью закончился
- **Подписка:** напоминания о продлении подписки

### Настройки:
- Настраиваемый порог для каждого расходника
- Возможность включения/выключения уведомлений
- Выбор получателей уведомлений (владелец/все менеджеры)

### Опциональные действия в уведомлении:
- "Создать заявку на закупку"
- "Добавить в лист пополнения"

## 8. Монетизация

### Тарифы:
- **Бесплатный пробный период:** 14 дней со всеми функциями премиума
- **Подписка:** $5/мес через Telegram Payment API

### Ограничения бесплатной версии:
- Ограниченное количество товаров (например, до 50)
- Отсутствие интеграции с CRM
- Ограниченное количество кнопок "одно действие"

### Премиум-версия:
- Неограниченное количество товаров
- Интеграция с CRM
- Неограниченное количество кнопок "одно действие"
- Расширенные уведомления
- Подробные отчёты и экспорт

## 9. Этапы разработки ИИ-агентом

### Этап 1: Создание базы данных и моделей
- Создать схемы таблиц в PostgreSQL
- Реализовать модели SQLAlchemy для всех сущностей:
  - User, Product, Rule, RuleItem, SalesLog, ManualButton, ManualButtonItem
- Настроить связи между таблицами (Foreign Keys)
- Создать индексы для оптимизации запросов

### Этап 2: Разработка Backend API (FastAPI)
- Настроить структуру проекта FastAPI
- Реализовать CRUD API для всех сущностей:
  - `/api/users` — управление пользователями
  - `/api/products` — товары и расходники
  - `/api/rules` — правила списания
  - `/api/buttons` — кнопки "одно действие"
  - `/api/logs` — журнал операций
- Реализовать авторизацию через Telegram WebApp Data
- Настроить CORS для Mini App

### Этап 3: Интеграция с CRM
- Создать универсальный слой интеграции с CRM
- Реализовать адаптеры для популярных CRM:
  - RemOnline (API + вебхуки)
  - amoCRM (API)
  - U-On (API)
  - Poster POS (API)
  - Универсальный адаптер для других CRM через API
- Настроить обработку вебхуков от CRM
- Реализовать polling для CRM без вебхуков
- Применение правил списания при получении событий продаж

### Этап 4: Разработка интерфейса Mini App
- Настроить структуру фронтенда (React/Vue или нативный JS)
- Реализовать экраны:
  - Первый экран (выбор режима)
  - Экран выбора CRM
  - Главный экран с навигацией
  - Экран "Склад"
  - Экран "Кнопки 'одно действие'"
  - Экран "Журнал"
  - Экран "Настройки"
  - Экран "Отчёты/Экспорт"
- Интегрировать Telegram WebApp SDK для работы с Mini App
- Реализовать адаптивный дизайн для мобильных устройств
- Настроить взаимодействие Frontend ↔ Backend API

### Этап 5: Реализация алгоритмов списания
- Алгоритм списания для ручного режима
- Алгоритм списания для автоматического режима (CRM)
- Логика применения правил списания
- Проверка порогов и отправка уведомлений
- Запись операций в журнал

### Этап 6: Настройка Telegram-уведомлений
- Интеграция с Telegram Bot API
- Реализация отправки уведомлений о низких остатках
- Настройка шаблонов уведомлений
- Реализация опциональных действий в уведомлениях

### Этап 7: Экспорт отчётов
- Реализация экспорта в CSV
- Реализация генерации PDF отчётов
- Создание различных типов отчётов:
  - Движение расходников
  - Использование кнопок
  - Остатки товаров
  - История операций

### Этап 8: Интеграция Telegram Payment API
- Настройка Telegram Payment API
- Реализация подписки через Telegram
- Настройка бесплатного пробного периода (14 дней)
- Реализация ограничений для бесплатной версии
- Проверка подписки при доступе к функциям

### Этап 9: Тестирование
- Протестировать ручной режим:
  - Добавление товаров
  - Ручное списание
  - Создание и использование кнопок "одно действие"
  - Проверка уведомлений
- Протестировать автоматический режим:
  - Подключение CRM
  - Получение событий продаж
  - Автоматическое списание по правилам
  - Уведомления
- Протестировать переключение между режимами
- Протестировать экспорт отчётов
- Протестировать подписку и ограничения

### Этап 10: Оптимизация и доработка
- Оптимизация производительности
- Улучшение UX/UI
- Добавление обработки ошибок
- Логирование операций
- Документация API

## 10. Технические детали

### Frontend (Telegram Mini App)
- **Технологии:** React/Vue или нативный JavaScript
- **Интеграция:** Telegram WebApp SDK
- **Стили:** адаптивный дизайн, поддержка темной/светлой темы Telegram
- **API:** взаимодействие с Backend через REST API

### Backend (FastAPI)
- **Технологии:** Python 3.10+, FastAPI, SQLAlchemy
- **База данных:** PostgreSQL
- **Авторизация:** Telegram WebApp Data validation
- **Интеграции:** HTTP клиенты для CRM API, обработка вебхуков

### База данных
- **СУБД:** PostgreSQL
- **ORM:** SQLAlchemy
- **Миграции:** Alembic

### Интеграции
- **Telegram Bot API:** для уведомлений
- **Telegram Payment API:** для подписки
- **CRM API:** RemOnline, amoCRM, U-On, Poster POS и другие
